# Viability Assessment – Follow-up Scope

| Item | Current Context (files, APIs) | Feasibility | Risks / Unknowns | Est. Effort | Plan / De-risking |
| --- | --- | --- | --- | --- | --- |
| True streaming for providers | `src/fmf/inference/azure_openai.py`, `src/fmf/inference/bedrock.py`, `src/fmf/inference/base_client.py`, no iterable API yet, transport mocked via callables | Medium | SDK streaming support not available offline; need to simulate with mocked chunks without new deps; ensure env flag gating | M | Introduce `iter_tokens` in provider base using generator pattern; gate behind `FMF_EXPERIMENTAL_STREAMING`; add unit tests with fake streaming transports returning chunk lists |
| Connector hardening | `src/fmf/connectors/local.py`, `s3.py`, `sharepoint.py` still using legacy protocol; no retries/backoff | Medium | SharePoint connector relies on msgraph SDK which may not be installed in tests; need to mock requests; ensure backward compatibility with existing config | M | Create `BaseConnector` subclasses, wrap reads with `contextlib.closing`, add retry helper (decorrelated jitter); implement tests using temp FS + moto stub (already optional) |
| Deterministic IDs & provenance | `src/fmf/types.py`, `src/fmf/core/interfaces/models.py` currently random UUIDs; no hashing utilities | Medium | Hash algorithm availability (xxhash not installed); need fallback; propagate IDs without breaking existing artefacts | M | Add `core/ids.py` with blake2b default + optional xxhash import; update document/chunk creation flows; tests ensure stable IDs for same content |
| Provider registry | Providers built via `inference/unified.py` factory with if/else; no registry | High | Minimal risk; ensure compatibility with existing config loader | S | Implement decorator-based registry (`inference/registry.py`), update `build_llm_client`; add unit tests ensuring fallback errors |
| Export idempotency & write modes | Exporters (e.g., `exporters/s3.py`, `dynamodb.py`, `sharepoint_excel.py`) accept `mode` but inconsistent; no atomic writes | Medium | Atomic writes on S3 require temp keys or conditional PUT; limited to append/overwrite; integration tests need mocking | L | Extend `ExportSpec`; implement local temp file rename; for S3 use upload then copy; add tests using moto or local FS |
| Error hierarchy | Multiple bespoke exceptions (ConnectorError, AuthError, etc.) | High | Need to avoid breaking except clauses elsewhere | S | Create `core/errors.py` deriving from `Exception`, update modules to alias or subclass existing errors; adjust tests |
| CI & quality upgrades | `.github/workflows/ci.yml` single-job Py3.12 only; no lint/coverage | Medium | Installing ruff/mypy/coverage offline may fail; coverage threshold may fail initially | M | Extend workflow matrix (3.11/3.12), add lint steps, configure minimal `ruff.toml` & `mypy.ini`, measure coverage with modest threshold (e.g., 70%) |
| Observability & time | `datetime.utcnow()` scattered (runner, cli, exporters); simple OTEL helper exists; logs need redaction | Medium | Need to ensure timezone change doesn’t break tests expecting string format; optional OTEL flag interacts with existing tracer stub | M | Introduce util `utc_now()` returning timezone-aware; update tests; add log redaction helper; gate OTEL spans behind env flag |
| “keys test” diagnostics | CLI already has `keys test` basic redaction in `src/fmf/cli.py`; needs richer diagnostics | High | Need to inspect configs without hitting real services; ensure backwards compatibility with tests | S | Extend command to read active profile, simulate connector/provider/exporter checks using safe no-op operations; add tests verifying output |

